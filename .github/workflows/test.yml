name: Test

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: Install dependencies
      run: bun install
      
    - name: Setup Go for gopls
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Install gopls
      run: go install golang.org/x/tools/gopls@latest
      
    - name: Setup Java for jdtls
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'
        
    - name: Install jdtls
      run: |
        # Download and install JDTLS from official snapshots
        mkdir -p ~/.local/share/eclipse.jdt.ls
        cd ~/.local/share/eclipse.jdt.ls
        curl -L -o jdtls-latest.tar.gz "http://download.eclipse.org/jdtls/snapshots/jdt-language-server-latest.tar.gz"
        tar -xzf jdtls-latest.tar.gz
        rm jdtls-latest.tar.gz
        
        # Create jdtls wrapper script
        sudo tee /usr/local/bin/jdtls > /dev/null <<'EOF'
        #!/bin/bash
        java -Declipse.application=org.eclipse.jdt.ls.core.id1 \
             -Dosgi.bundles.defaultStartLevel=4 \
             -Declipse.product=org.eclipse.jdt.ls.core.product \
             -Xms1g -Xmx2G \
             -jar ~/.local/share/eclipse.jdt.ls/plugins/org.eclipse.equinox.launcher_*.jar \
             -configuration ~/.local/share/eclipse.jdt.ls/config_linux \
             -data "${1:-$HOME/workspace}" \
             --add-modules=ALL-SYSTEM \
             --add-opens java.base/java.util=ALL-UNNAMED \
             --add-opens java.base/java.lang=ALL-UNNAMED "$@"
        EOF
        sudo chmod +x /usr/local/bin/jdtls
        
    - name: Install lua-language-server
      run: |
        sudo apt-get install -y lua5.4 lua5.4-dev
        # Get the latest release info and extract the correct download URL
        LATEST_URL=$(curl -s https://api.github.com/repos/LuaLS/lua-language-server/releases/latest | grep "browser_download_url.*linux-x64.tar.gz" | cut -d '"' -f 4)
        wget -O lua-language-server.tar.gz "$LATEST_URL"
        sudo mkdir -p /opt/lua-language-server
        sudo tar -xzf lua-language-server.tar.gz -C /opt/lua-language-server
        sudo ln -sf /opt/lua-language-server/bin/lua-language-server /usr/local/bin/lua-language-server
        
    - name: Install shellcheck
      run: sudo apt-get install -y shellcheck
      
    - name: Run type checking
      run: bun run typecheck
      
    - name: Build CLI
      run: bun run build
      
    - name: Make CLI executable
      run: chmod +x ./lspcli
      
    - name: Verify CLI works
      run: ./lspcli status
      
    - name: Run tests
      run: bun run test