# Plan: Set up changesets for lspcli

## Overview

Add changesets for version management with two GitHub Actions workflows. Keep the existing `release.ts` for manual npm publishing. Changesets handles version bumping via PRs and git tags; `release.ts` handles building and publishing to npm.

## Files to create

### 1. `.changeset/config.json` (already created)

### 2. `.changeset/README.md` (already created)

### 3. `.github/workflows/changeset-check.yml` (already created)

Mirrors barkql: requires a changeset on PRs that touch `src/`.

### 4. `.github/workflows/version.yml` (already created)

Uses `changeset tag` (like repos). Changesets creates version PRs and git tags/GitHub releases. No npm publishing in CI.

**Wait** — with the `--publish-only` flag and trusted publishing, version.yml SHOULD publish. Updated approach:

- `publish: bun run release --publish-only`
- Needs `id-token: write` permission for OIDC
- Needs Node 24+ (for npm >=11.5.1)
- Needs `setup-node` with `registry-url: 'https://registry.npmjs.org'`

## Files to modify

### 5. `script/release.ts`

Two changes:

1. **Add `--publish-only` flag**: Skips version bumping, git validation, interactive prompts, git commit/tag. Just reads version from `package.json`, builds binaries, and publishes all 6 packages.
2. **Switch from `bun publish` to `npm publish`**: Use `npm publish --access public` everywhere. In CI, provenance is added via `NPM_CONFIG_PROVENANCE=true` env var in the workflow (so release.ts doesn't need to know about it).

The `--publish-only` flow:

1. Read `pkg.version` (already bumped by `changeset version`)
2. `build(version)` — build all 5 platform binaries
3. Publish each platform package: `npm publish --access public` (from `dist/<name>/`)
4. Publish main package: `npm publish --access public` (from `dist/cli-lsp-client/`)

Existing manual flow (`bun run release [patch|minor|major]`) remains unchanged except `bun publish` → `npm publish`.

### 6. `package.json`

- Add devDependencies: `@changesets/cli`, `@changesets/changelog-github`
- Keep existing `"release": "./script/release.ts"` script as-is

### 7. `.github/workflows/version.yml` (update already-created file)

```yaml
name: Version

on:
  push:
    branches: [main]

jobs:
  version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2

      - uses: actions/setup-node@v4
        with:
          node-version: '24'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: bun install

      - name: Create Release Pull Request or Publish
        uses: changesets/action@v1
        with:
          version: bunx changeset version
          publish: bun run release --publish-only
          title: 'chore: version packages'
          createGithubReleases: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_CONFIG_PROVENANCE: true
```

## npm trusted publishing setup (manual step after code changes)

Configure trusted publishing on npmjs.com for each of the 6 packages:

- `cli-lsp-client`
- `cli-lsp-client-darwin-arm64`
- `cli-lsp-client-darwin-x64`
- `cli-lsp-client-linux-arm64`
- `cli-lsp-client-linux-x64`
- `cli-lsp-client-windows-x64`

For each: Settings > Trusted Publisher > GitHub Actions:

- **Organization or user**: `eli0shin`
- **Repository**: `cli-lsp-client`
- **Workflow filename**: `version.yml`

## Verification

1. `bun install` — installs changeset deps
2. `bun run typecheck` — no type errors
3. `bun run build` — build still works
4. `bun run release --publish-only --dry-run` — verify publish-only flow
